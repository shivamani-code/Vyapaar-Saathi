<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Vyapaar-Saathi — Financial Co-Pilot</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/file-saver@2.0.5/dist/FileSaver.min.js"></script>
    <style>
        :root {
            --bg1: #071422;
            --bg2: #08263b;
            --bg3: #021629;
            --card: #0f1720;
            --muted: #9aa6b2;
            --accent: #10b981;
            --text: #e6eef5;
            --danger: #f87171;
            --warning: #f59e0b;
            --info: #60a5fa;
            --purple: #a855f7;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background: linear-gradient(180deg, var(--bg1), var(--bg2), var(--bg3));
            color: var(--text);
            min-height: 100vh;
            line-height: 1.6;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .hidden {
            display: none !important;
        }

        /* Auth Screen */
        #auth-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
            background: linear-gradient(135deg, var(--bg1) 0%, var(--bg2) 50%, var(--bg3) 100%);
        }

        .auth-card {
            background: var(--card);
            border-radius: 16px;
            padding: 35px;
            width: 100%;
            max-width: 450px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
            animation: fadeIn 0.5s ease-out;
        }

        .auth-card h2 {
            text-align: center;
            margin-bottom: 10px;
            color: var(--accent);
            font-size: 28px;
        }

        .auth-card p {
            text-align: center;
            margin-bottom: 30px;
            color: var(--muted);
            font-size: 16px;
        }

        .auth-card input {
            width: 100%;
            padding: 15px;
            margin-bottom: 20px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.25);
            color: var(--text);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .auth-card input:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .auth-actions {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }

        .btn {
            padding: 14px 22px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--accent);
            color: #042024;
            flex: 2;
        }

        .btn-alt {
            background: rgba(255, 255, 255, 0.08);
            color: var(--text);
            flex: 1;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
        }

        .btn:hover {
            opacity: 0.9;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .error {
            color: var(--danger);
            margin-top: 15px;
            text-align: center;
            font-size: 14px;
            padding: 10px;
            background: rgba(248, 113, 113, 0.1);
            border-radius: 8px;
            border-left: 4px solid var(--danger);
        }

        /* App Layout */
        #app-screen {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Topbar */
        #topbar {
            background: linear-gradient(90deg, #0b1720, #082033);
            padding: 18px 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .brand i {
            color: var(--accent);
            font-size: 28px;
        }

        .brand-text h1 {
            font-size: 22px;
            font-weight: 700;
        }

        .brand-text p {
            font-size: 13px;
            color: var(--muted);
        }

        .user-actions {
            display: flex;
            align-items: center;
            gap: 18px;
        }

        /* Main Content */
        .app-content {
            display: flex;
            flex: 1;
            gap: 25px;
            padding: 25px;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .sidebar-card {
            background: var(--card);
            border-radius: 14px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        }

        .welcome-text {
            color: var(--muted);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .user-email {
            font-weight: 600;
            font-size: 19px;
            margin-bottom: 25px;
            word-break: break-all;
            color: var(--accent);
        }

        .nav-buttons {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .nav-btn {
            padding: 14px 18px;
            background: transparent;
            border: 1px solid transparent;
            border-radius: 10px;
            color: var(--text);
            text-align: left;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 15px;
        }

        .nav-btn:hover {
            background: rgba(255, 255, 255, 0.05);
            border-color: rgba(255, 255, 255, 0.1);
        }

        .nav-btn.active {
            background: var(--accent);
            color: #042024;
            font-weight: 600;
            box-shadow: 0 5px 15px rgba(16, 185, 129, 0.3);
        }

        .streak-card {
            text-align: center;
            background: linear-gradient(135deg, var(--purple), #7e22ce) !important;
        }

        .streak-card .small {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .streak {
            font-size: 28px;
            font-weight: 700;
            margin: 12px 0;
            color: white;
        }

        /* Main View */
        .main-view {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 25px;
        }

        .view {
            background: var(--card);
            border-radius: 14px;
            padding: 25px;
            border: 1px solid rgba(255, 255, 255, 0.06);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
            animation: fadeIn 0.4s ease-out;
        }

        .view h2 {
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--accent);
        }

        /* Dashboard */
        .metrics {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 20px;
            margin-bottom: 25px;
        }

        .metric-card {
            background: rgba(0, 0, 0, 0.25);
            border-radius: 12px;
            padding: 25px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.06);
            transition: all 0.3s ease;
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2);
        }

        .metric-title {
            color: var(--muted);
            margin-bottom: 12px;
            font-size: 15px;
        }

        .metric-value {
            font-size: 28px;
            font-weight: 700;
        }

        .chart-container {
            height: 320px;
            position: relative;
            margin-top: 15px;
        }

        /* Ledger */
        .entry-form {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 18px;
            margin-bottom: 25px;
        }

        .entry-form input,
        .entry-form textarea,
        .entry-form select {
            padding: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            background: rgba(0, 0, 0, 0.25);
            color: var(--text);
            font-size: 16px;
            transition: all 0.3s ease;
        }

        .entry-form input:focus,
        .entry-form textarea:focus,
        .entry-form select:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.2);
        }

        .entry-form textarea {
            grid-column: span 2;
            resize: vertical;
            min-height: 110px;
        }

        .form-actions {
            grid-column: span 2;
            display: flex;
            gap: 12px;
        }

        .entries-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .entry-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            border-left: 4px solid var(--accent);
            transition: all 0.3s ease;
        }

        .entry-item:hover {
            background: rgba(0, 0, 0, 0.2);
            transform: translateX(5px);
        }

        .entry-details {
            flex: 1;
            overflow: hidden;
        }

        .entry-note {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 16px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .entry-meta {
            font-size: 13px;
            color: var(--muted);
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .entry-amount {
            font-weight: 700;
            font-size: 19px;
            white-space: nowrap;
            margin-left: 10px;
        }

        /* Nudges */
        .nudge-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 18px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            margin-bottom: 12px;
            border-left: 4px solid var(--info);
        }

        .nudge-details {
            flex: 1;
        }

        .nudge-title {
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 16px;
        }

        .nudge-meta {
            font-size: 13px;
            color: var(--muted);
        }

        /* Responsive */
        @media (max-width: 900px) {
            .app-content {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
            }
            
            .metrics {
                grid-template-columns: 1fr;
            }
            
            .entry-form {
                grid-template-columns: 1fr;
            }
            
            .entry-form textarea,
            .form-actions {
                grid-column: span 1;
            }
            
            .entry-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .entry-amount {
                margin-left: 0;
                align-self: flex-end;
            }
        }

        /* Footer */
        .app-footer {
            text-align: center;
            padding: 25px;
            color: var(--muted);
            border-top: 1px solid rgba(255, 255, 255, 0.05);
            margin-top: auto;
            background: rgba(0, 0, 0, 0.2);
        }

        /* Animations */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Loading spinner */
        .spinner {
            width: 24px;
            height: 24px;
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
            display: inline-block;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Toast notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            padding: 15px 20px;
            background: var(--card);
            color: var(--text);
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            animation: toastIn 0.3s ease-out, toastOut 0.3s ease-in 2.7s forwards;
            border-left: 4px solid var(--accent);
            max-width: 350px;
        }

        @keyframes toastIn {
            from { transform: translateX(100px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        @keyframes toastOut {
            from { transform: translateX(0); opacity: 1; }
            to { transform: translateX(100px); opacity: 0; }
        }

        /* Category tags */
        .category-tag {
            display: inline-block;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-right: 8px;
        }

        .category-income {
            background: rgba(16, 185, 129, 0.2);
            color: var(--accent);
        }

        .category-expense {
            background: rgba(248, 113, 113, 0.2);
            color: var(--danger);
        }
        
        /* Badges */
        .badge {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent), #059669);
            color: white;
            font-size: 18px;
            margin-right: 10px;
        }
        
        /* Nudge completion */
        .nudge-completed {
            opacity: 0.7;
            text-decoration: line-through;
        }
        
        .nudge-completed .nudge-title {
            color: var(--muted);
        }

        /* Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .modal {
            background: var(--card);
            border-radius: 14px;
            padding: 25px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.08);
        }

        .modal h3 {
            margin-bottom: 20px;
            color: var(--accent);
        }

        .modal input,
        .modal textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            background: rgba(0, 0, 0, 0.25);
            color: var(--text);
        }

        .modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }

        /* New features */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .quick-action-btn {
            padding: 15px;
            background: rgba(0, 0, 0, 0.2);
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .quick-action-btn:hover {
            background: rgba(0, 0, 0, 0.3);
            transform: translateY(-3px);
        }

        .quick-action-btn i {
            font-size: 24px;
            margin-bottom: 10px;
            color: var(--accent);
        }

        .expense-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 25px;
        }

        .expense-category {
            padding: 15px;
            background: rgba(0, 0, 0, 0.15);
            border-radius: 10px;
            text-align: center;
        }

        .expense-category .title {
            color: var(--muted);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .expense-category .amount {
            font-weight: 600;
            font-size: 18px;
        }

        .nudge-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .transaction-actions {
            display: flex;
            gap: 8px;
        }

        .transaction-actions button {
            padding: 6px 10px;
            border-radius: 6px;
            font-size: 12px;
        }
    </style>
</head>
<body>
    <!-- Auth Screen -->
    <div id="auth-screen">
        <div class="auth-card">
            <h2><i class="fas fa-coins"></i> Vyapaar-Saathi</h2>
            <p>Smart, local-first financial co-pilot — login to continue.</p>
            
            <input type="email" id="auth-email" placeholder="Email" autocomplete="email">
            <input type="password" id="auth-password" placeholder="Password" autocomplete="current-password">
            
            <div class="auth-actions">
                <button id="auth-action" class="btn btn-primary">
                    <i class="fas fa-sign-in-alt"></i> Login
                </button>
                <button id="auth-toggle" class="btn btn-alt">
                    <i class="fas fa-user-plus"></i> Register
                </button>
            </div>
            
            <div id="auth-error" class="error hidden"></div>
            <p class="small" style="text-align: center; margin-top: 25px; color: var(--muted);">
                Use any email/password for demo (will be stored in Firebase)
            </p>
        </div>
    </div>

    <!-- App Screen -->
    <div id="app-screen" class="hidden">
        <!-- Topbar -->
        <header id="topbar">
            <div class="brand">
                <i class="fas fa-coins"></i>
                <div class="brand-text">
                    <h1>Vyapaar-Saathi</h1>
                    <p>Aapka financial co-pilot</p>
                </div>
            </div>
            
            <div class="user-actions">
                <div id="user-id">user@example.com</div>
                <button id="logout-btn" class="btn btn-alt">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </header>

        <!-- Main Content -->
        <div class="app-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <div class="sidebar-card">
                    <div class="welcome-text">Welcome</div>
                    <div id="welcome-id" class="user-email">user@example.com</div>
                    
                    <div class="nav-buttons">
                        <button data-view="dashboard" class="nav-btn active">
                            <i class="fas fa-chart-line"></i> Dashboard
                        </button>
                        <button data-view="ledger" class="nav-btn">
                            <i class="fas fa-book"></i> Ledger
                        </button>
                        <button data-view="scenarios" class="nav-btn">
                            <i class="fas fa-project-diagram"></i> Scenarios
                        </button>
                        <button data-view="nudges" class="nav-btn">
                            <i class="fas fa-lightbulb"></i> Nudges
                        </button>
                        <button data-view="export" class="nav-btn">
                            <i class="fas fa-file-export"></i> Export
                        </button>
                    </div>
                </div>
                
                <div class="sidebar-card streak-card">
                    <div class="small">Current Streak</div>
                    <div class="streak">3 <i class="fas fa-fire"></i></div>
                    <div class="small">Complete 1 micro-task daily</div>
                </div>

                <div class="sidebar-card">
                    <div class="welcome-text">Quick Stats</div>
                    <div id="quick-stats">
                        <div class="small">Transactions: <span id="stat-transactions">0</span></div>
                        <div class="small">This month: <span id="stat-month">₹0</span></div>
                        <div class="small">Categories: <span id="stat-categories">0</span></div>
                    </div>
                </div>
            </aside>

            <!-- Main View -->
            <main class="main-view">
                <!-- Dashboard View -->
                <section id="view-dashboard" class="view">
                    <h2><i class="fas fa-chart-line"></i> Financial Dashboard</h2>
                    
                    <div class="quick-actions">
                        <div class="quick-action-btn" data-action="add-income">
                            <i class="fas fa-money-bill-wave"></i>
                            <div>Add Income</div>
                        </div>
                        <div class="quick-action-btn" data-action="add-expense">
                            <i class="fas fa-shopping-cart"></i>
                            <div>Add Expense</div>
                        </div>
                        <div class="quick-action-btn" data-action="add-nudge">
                            <i class="fas fa-plus-circle"></i>
                            <div>Create Nudge</div>
                        </div>
                        <div class="quick-action-btn" data-action="view-report">
                            <i class="fas fa-chart-pie"></i>
                            <div>View Report</div>
                        </div>
                    </div>
                    
                    <div class="metrics">
                        <div class="metric-card">
                            <div class="metric-title">Inflow</div>
                            <div id="total-in" class="metric-value">₹0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-title">Outflow</div>
                            <div id="total-out" class="metric-value">₹0</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-title">Net</div>
                            <div id="total-net" class="metric-value">₹0</div>
                        </div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="cashflow-chart"></canvas>
                    </div>

                    <div style="margin-top: 25px;">
                        <h3><i class="fas fa-history"></i> Recent Transactions</h3>
                        <div id="recent-transactions" class="entries-list" style="margin-top: 15px;">
                            <!-- Recent transactions will be added here -->
                        </div>
                    </div>

                    <div class="expense-categories">
                        <div class="expense-category">
                            <div class="title">Supplies</div>
                            <div class="amount" id="category-supplies">₹0</div>
                        </div>
                        <div class="expense-category">
                            <div class="title">Services</div>
                            <div class="amount" id="category-services">₹0</div>
                        </div>
                        <div class="expense-category">
                            <div class="title">Transport</div>
                            <div class="amount" id="category-transport">₹0</div>
                        </div>
                        <div class="expense-category">
                            <div class="title">Utilities</div>
                            <div class="amount" id="category-utilities">₹0</div>
                        </div>
                    </div>
                </section>

                <!-- Ledger View -->
                <section id="view-ledger" class="view hidden">
                    <h2><i class="fas fa-book"></i> Transaction Ledger</h2>
                    
                    <div class="entry-form">
                        <input type="number" id="in-amt" placeholder="Cash In (₹)" min="0">
                        <input type="number" id="out-amt" placeholder="Cash Out (₹)" min="0">
                        <select id="category">
                            <option value="">Select Category</option>
                            <option value="sales">Sales</option>
                            <option value="supplies">Supplies</option>
                            <option value="services">Services</option>
                            <option value="transport">Transport</option>
                            <option value="utilities">Utilities</option>
                            <option value="other">Other</option>
                        </select>
                        <input type="date" id="entry-date">
                        <textarea id="note" placeholder="Note (e.g., bought supplies)"></textarea>
                        
                        <div class="form-actions">
                            <button id="add-entry" class="btn btn-primary">
                                <i class="fas fa-plus"></i> Add Entry
                            </button>
                            <button id="voice-btn" class="btn btn-alt">
                                <i class="fas fa-microphone"></i> Voice Input
                            </button>
                            <button id="clear-form" class="btn btn-alt">
                                <i class="fas fa-times"></i> Clear
                            </button>
                        </div>
                    </div>
                    
                    <div class="entries-filters" style="margin-bottom: 20px; display: flex; gap: 10px; flex-wrap: wrap;">
                        <input type="text" id="search-entries" placeholder="Search transactions..." style="flex: 1; padding: 12px; min-width: 200px;">
                        <select id="filter-category" style="width: 180px; padding: 12px;">
                            <option value="">All Categories</option>
                            <option value="sales">Sales</option>
                            <option value="supplies">Supplies</option>
                            <option value="services">Services</option>
                            <option value="transport">Transport</option>
                            <option value="utilities">Utilities</option>
                            <option value="other">Other</option>
                        </select>
                        <select id="filter-type" style="width: 120px; padding: 12px;">
                            <option value="">All Types</option>
                            <option value="income">Income</option>
                            <option value="expense">Expense</option>
                        </select>
                    </div>
                    
                    <div id="entries-list" class="entries-list">
                        <!-- Entries will be added here dynamically -->
                    </div>
                </section>

                <!-- Scenarios View -->
                <section id="view-scenarios" class="view hidden">
                    <h2><i class="fas fa-project-diagram"></i> Financial Scenarios</h2>
                    
                    <div class="scenario-controls">
                        <div class="metric-title">If I save</div>
                        <input type="range" id="save-range" min="10" max="500" value="50" style="width: 100%; margin: 15px 0;">
                        <div class="metric-value" id="save-per-day">₹50/day</div>
                    </div>
                    
                    <div class="chart-container">
                        <canvas id="scenario-chart"></canvas>
                    </div>

                    <div style="margin-top: 30px;">
                        <h3><i class="fas fa-calculator"></i> Savings Calculator</h3>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-top: 15px;">
                            <div>
                                <div class="metric-title">Monthly Savings</div>
                                <div class="metric-value" id="monthly-saving">₹1,500</div>
                            </div>
                            <div>
                                <div class="metric-title">Yearly Savings</div>
                                <div class="metric-value" id="yearly-saving">₹18,000</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <h3><i class="fas fa-bullseye"></i> Goal Setting</h3>
                        <div style="margin-top: 15px;">
                            <input type="text" id="goal-name" placeholder="Goal name (e.g., New equipment)" style="width: 100%; padding: 12px; margin-bottom: 10px;">
                            <input type="number" id="goal-amount" placeholder="Amount needed (₹)" style="width: 100%; padding: 12px; margin-bottom: 10px;">
                            <button id="set-goal" class="btn btn-primary" style="width: 100%;">
                                <i class="fas fa-target"></i> Set Savings Goal
                            </button>
                        </div>
                        <div id="goal-progress" style="margin-top: 20px; display: none;">
                            <div class="metric-title">Goal: <span id="goal-title"></span></div>
                            <div class="metric-title">Target: ₹<span id="goal-target"></span></div>
                            <div class="metric-title">Saved: ₹<span id="goal-saved"></span></div>
                            <div style="background: rgba(255,255,255,0.1); height: 20px; border-radius: 10px; margin-top: 10px;">
                                <div id="goal-progress-bar" style="height: 100%; border-radius: 10px; background: var(--accent); width: 0%;"></div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Nudges View -->
                <section id="view-nudges" class="view hidden">
                    <h2><i class="fas fa-lightbulb"></i> Smart Nudges</h2>
                    <p>Today's small steps to improve your finances:</p>
                    
                    <div class="nudge-actions">
                        <button id="create-nudge" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Create New Nudge
                        </button>
                        <button id="clear-completed" class="btn btn-alt">
                            <i class="fas fa-trash"></i> Clear Completed
                        </button>
                    </div>
                    
                    <ul id="nudges-list" class="entries-list" style="margin-top: 20px;">
                        <!-- Nudges will be loaded here -->
                    </ul>

                    <div style="margin-top: 30px;">
                        <h3><i class="fas fa-trophy"></i> Achievement Badges</h3>
                        <div style="display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap;">
                            <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; min-width: 120px;">
                                <i class="fas fa-calendar-check" style="font-size: 30px; color: var(--accent);"></i>
                                <div style="margin-top: 8px;">7-Day Streak</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; min-width: 120px;">
                                <i class="fas fa-chart-line" style="font-size: 30px; color: var(--accent);"></i>
                                <div style="margin-top: 8px;">First Sale</div>
                            </div>
                            <div style="text-align: center; padding: 15px; background: rgba(0,0,0,0.2); border-radius: 10px; min-width: 120px;">
                                <i class="fas fa-piggy-bank" style="font-size: 30px; color: var(--accent);"></i>
                                <div style="margin-top: 8px;">Savings Goal</div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Export View -->
                <section id="view-export" class="view hidden">
                    <h2><i class="fas fa-file-export"></i> Export Data</h2>
                    <p>Download your financial data for record keeping or analysis:</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 25px;">
                        <div style="padding: 20px; background: rgba(0,0,0,0.1); border-radius: 10px;">
                            <h3><i class="fas fa-file-csv"></i> CSV Export</h3>
                            <p style="margin: 10px 0; color: var(--muted);">Export your transaction history as CSV for spreadsheets</p>
                            <button id="export-csv" class="btn btn-primary" style="width: 100%;">
                                <i class="fas fa-download"></i> Download CSV
                            </button>
                        </div>
                        
                        <div style="padding: 20px; background: rgba(0,0,0,0.1); border-radius: 10px;">
                            <h3><i class="fas fa-file-pdf"></i> PDF Report</h3>
                            <p style="margin: 10px 0; color: var(--muted);">Generate a detailed PDF financial report</p>
                            <button id="export-pdf" class="btn btn-primary" style="width: 100%;">
                                <i class="fas fa-download"></i> Generate PDF
                            </button>
                        </div>
                    </div>

                    <div style="margin-top: 30px;">
                        <h3><i class="fas fa-cog"></i> Export Options</h3>
                        <div style="display: flex; gap: 15px; margin-top: 15px; flex-wrap: wrap;">
                            <select id="export-range" style="flex: 1; padding: 12px; min-width: 200px;">
                                <option value="all">All Time</option>
                                <option value="month">This Month</option>
                                <option value="quarter">This Quarter</option>
                                <option value="year">This Year</option>
                            </select>
                            <select id="export-format" style="width: 180px; padding: 12px;">
                                <option value="detailed">Detailed Report</option>
                                <option value="summary">Summary Only</option>
                            </select>
                        </div>
                    </div>
                </section>
            </main>
        </div>

        <!-- Footer -->
        <footer class="app-footer">
            © <span id="current-year"></span> Vyapaar-Saathi — Demo build for hackathon
        </footer>
    </div>

    <!-- Create Nudge Modal -->
    <div id="nudge-modal" class="modal-overlay hidden">
        <div class="modal">
            <h3><i class="fas fa-lightbulb"></i> Create New Nudge</h3>
            <input type="text" id="nudge-title" placeholder="Nudge title">
            <textarea id="nudge-meta" placeholder="Additional details (optional)"></textarea>
            <div class="modal-actions">
                <button id="cancel-nudge" class="btn btn-alt">Cancel</button>
                <button id="save-nudge" class="btn btn-primary">Save Nudge</button>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyAomWkyS2SntrJuvChz80dV-8CPhl5V-6M",
            authDomain: "vyapaar-saathi-b0554.firebaseapp.com",
            projectId: "vyapaar-saathi-b0554",
            storageBucket: "vyapaar-saathi-b0554.firebasestorage.app",
            messagingSenderId: "823930154044",
            appId: "1:823930154044:web:24ebfce2c41300b489e739",
            measurementId: "G-Z3BG3E8XBY"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();

        // DOM elements
        const authScreen = document.getElementById('auth-screen');
        const appScreen = document.getElementById('app-screen');
        const authEmail = document.getElementById('auth-email');
        const authPassword = document.getElementById('auth-password');
        const authAction = document.getElementById('auth-action');
        const authToggle = document.getElementById('auth-toggle');
        const authError = document.getElementById('auth-error');
        const logoutBtn = document.getElementById('logout-btn');
        const userIdEl = document.getElementById('user-id');
        const welcomeIdEl = document.getElementById('welcome-id');
        const currentYearEl = document.getElementById('current-year');
        
        // Views
        const views = document.querySelectorAll('.view');
        const navBtns = document.querySelectorAll('.nav-btn');
        
        // Dashboard elements
        const totalInEl = document.getElementById('total-in');
        const totalOutEl = document.getElementById('total-out');
        const totalNetEl = document.getElementById('total-net');
        const recentTransactionsEl = document.getElementById('recent-transactions');
        
        // Ledger elements
        const inAmtEl = document.getElementById('in-amt');
        const outAmtEl = document.getElementById('out-amt');
        const noteEl = document.getElementById('note');
        const categoryEl = document.getElementById('category');
        const entryDateEl = document.getElementById('entry-date');
        const addEntryBtn = document.getElementById('add-entry');
        const clearFormBtn = document.getElementById('clear-form');
        const entriesList = document.getElementById('entries-list');
        const searchEntriesEl = document.getElementById('search-entries');
        const filterCategoryEl = document.getElementById('filter-category');
        const filterTypeEl = document.getElementById('filter-type');
        
        // Scenario elements
        const saveRange = document.getElementById('save-range');
        const savePerDayEl = document.getElementById('save-per-day');
        const monthlySavingEl = document.getElementById('monthly-saving');
        const yearlySavingEl = document.getElementById('yearly-saving');
        const goalNameEl = document.getElementById('goal-name');
        const goalAmountEl = document.getElementById('goal-amount');
        const setGoalBtn = document.getElementById('set-goal');
        const goalProgressEl = document.getElementById('goal-progress');
        const goalTitleEl = document.getElementById('goal-title');
        const goalTargetEl = document.getElementById('goal-target');
        const goalSavedEl = document.getElementById('goal-saved');
        const goalProgressBarEl = document.getElementById('goal-progress-bar');
        
        // Export elements
        const exportCsvBtn = document.getElementById('export-csv');
        const exportPdfBtn = document.getElementById('export-pdf');
        
        // Nudges elements
        const nudgesList = document.getElementById('nudges-list');
        const createNudgeBtn = document.getElementById('create-nudge');
        const clearCompletedBtn = document.getElementById('clear-completed');
        const nudgeModal = document.getElementById('nudge-modal');
        const nudgeTitleEl = document.getElementById('nudge-title');
        const nudgeMetaEl = document.getElementById('nudge-meta');
        const saveNudgeBtn = document.getElementById('save-nudge');
        const cancelNudgeBtn = document.getElementById('cancel-nudge');
        
        // Stats elements
        const statTransactionsEl = document.getElementById('stat-transactions');
        const statMonthEl = document.getElementById('stat-month');
        const statCategoriesEl = document.getElementById('stat-categories');
        
        // Quick actions
        const quickActionBtns = document.querySelectorAll('.quick-action-btn');
        
        // Charts
        let cashflowChart = null;
        let scenarioChart = null;
        
        // Current user and data
        let currentUser = null;
        let entries = [];
        let nudges = [];
        let savingsGoal = null;
        let loading = false;

        // Set current date as default for new entries
        entryDateEl.valueAsDate = new Date();
        
        // Set current year
        currentYearEl.textContent = new Date().getFullYear();
        
        // Default nudges
        const defaultNudges = [
            { id: 1, text: "Check other supplier for 10% cheaper rates", meta: "Savings potential: ₹2,000/month", completed: false },
            { id: 2, text: "Call top 3 customers with pending payments", meta: "₹15,000 receivable", completed: false },
            { id: 3, text: "Review monthly subscriptions", meta: "Potential savings: ₹500/month", completed: false },
            { id: 4, text: "Set aside 10% of today's earnings for taxes", meta: "Better financial planning", completed: false },
            { id: 5, text: "Compare prices for regular supplies", meta: "Find better deals", completed: false }
        ];
        
        // Auth state listener
        auth.onAuthStateChanged((user) => {
            if (user) {
                currentUser = user;
                userIdEl.textContent = user.email;
                welcomeIdEl.textContent = user.email;
                showApp();
                loadUserData();
                loadNudges();
                loadSavingsGoal();
            } else {
                showAuth();
            }
        });
        
        // Auth mode toggle
        let isLoginMode = true;
        authToggle.addEventListener('click', () => {
            isLoginMode = !isLoginMode;
            authAction.textContent = isLoginMode ? 'Login' : 'Register';
            authToggle.innerHTML = isLoginMode ? 
                '<i class="fas fa-user-plus"></i> Register' : 
                '<i class="fas fa-sign-in-alt"></i> Login';
            authError.classList.add('hidden');
        });
        
        // Auth action
        authAction.addEventListener('click', async () => {
            const email = authEmail.value;
            const password = authPassword.value;
            
            if (!email || !password) {
                showError('Please enter email and password');
                return;
            }
            
            setLoading(true);
            
            try {
                if (isLoginMode) {
                    await auth.signInWithEmailAndPassword(email, password);
                    showToast('Login successful!');
                } else {
                    await auth.createUserWithEmailAndPassword(email, password);
                    showToast('Account created successfully!');
                }
            } catch (error) {
                showError(error.message);
            } finally {
                setLoading(false);
            }
        });
        
        // Logout
        logoutBtn.addEventListener('click', () => {
            auth.signOut();
            showToast('Logged out successfully');
        });
        
        // Navigation
        navBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const viewName = btn.getAttribute('data-view');
                
                // Update active button
                navBtns.forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
                
                // Show selected view
                views.forEach(view => view.classList.add('hidden'));
                document.getElementById(`view-${viewName}`).classList.remove('hidden');
                
                // Initialize view if needed
                if (viewName === 'dashboard') {
                    updateDashboard();
                } else if (viewName === 'scenarios') {
                    updateScenarioChart();
                } else if (viewName === 'nudges') {
                    renderNudges();
                }
            });
        });
        
        // Add entry
        addEntryBtn.addEventListener('click', () => {
            const inAmt = parseInt(inAmtEl.value) || 0;
            const outAmt = parseInt(outAmtEl.value) || 0;
            const note = noteEl.value;
            const category = categoryEl.value;
            const date = entryDateEl.value;
            
            if (inAmt === 0 && outAmt === 0) {
                showError('Please enter an amount');
                return;
            }
            
            if (!note) {
                showError('Please add a note');
                return;
            }
            
            if (!category) {
                showError('Please select a category');
                return;
            }
            
            addEntry(inAmt, outAmt, note, category, date);
            
            // Clear form
            clearForm();
            
            showToast('Transaction added successfully!');
        });
        
        // Clear form
        clearFormBtn.addEventListener('click', clearForm);
        
        // Scenario slider
        saveRange.addEventListener('input', () => {
            const value = saveRange.value;
            savePerDayEl.textContent = `₹${value}/day`;
            monthlySavingEl.textContent = `₹${(value * 30).toLocaleString()}`;
            yearlySavingEl.textContent = `₹${(value * 365).toLocaleString()}`;
            updateScenarioChart();
        });
        
        // Set savings goal
        setGoalBtn.addEventListener('click', () => {
            const goalName = goalNameEl.value;
            const goalAmount = parseInt(goalAmountEl.value);
            
            if (!goalName || !goalAmount) {
                showToast('Please enter both goal name and amount');
                return;
            }
            
            setSavingsGoal(goalName, goalAmount);
        });
        
        // Search and filter
        searchEntriesEl.addEventListener('input', renderEntries);
        filterCategoryEl.addEventListener('change', renderEntries);
        filterTypeEl.addEventListener('change', renderEntries);
        
        // Export buttons
        exportCsvBtn.addEventListener('click', exportToCSV);
        exportPdfBtn.addEventListener('click', exportToPDF);
        
        // Voice input (placeholder)
        document.getElementById('voice-btn').addEventListener('click', () => {
            showToast('Voice input would be implemented here');
        });
        
        // Nudge management
        createNudgeBtn.addEventListener('click', () => {
            nudgeModal.classList.remove('hidden');
        });
        
        cancelNudgeBtn.addEventListener('click', () => {
            nudgeModal.classList.add('hidden');
            nudgeTitleEl.value = '';
            nudgeMetaEl.value = '';
        });
        
        saveNudgeBtn.addEventListener('click', () => {
            const title = nudgeTitleEl.value;
            const meta = nudgeMetaEl.value;
            
            if (!title) {
                showToast('Please enter a nudge title');
                return;
            }
            
            createNudge(title, meta);
            nudgeModal.classList.add('hidden');
            nudgeTitleEl.value = '';
            nudgeMetaEl.value = '';
        });
        
        clearCompletedBtn.addEventListener('click', () => {
            clearCompletedNudges();
        });
        
        // Quick actions
        quickActionBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const action = btn.getAttribute('data-action');
                
                switch(action) {
                    case 'add-income':
                        // Switch to ledger and pre-fill income
                        document.querySelector('[data-view="ledger"]').click();
                        inAmtEl.focus();
                        break;
                    case 'add-expense':
                        // Switch to ledger and pre-fill expense
                        document.querySelector('[data-view="ledger"]').click();
                        outAmtEl.focus();
                        break;
                    case 'add-nudge':
                        // Open nudge creation modal
                        nudgeModal.classList.remove('hidden');
                        break;
                    case 'view-report':
                        // Switch to export view
                        document.querySelector('[data-view="export"]').click();
                        break;
                }
            });
        });
        
        // Functions
        function showAuth() {
            authScreen.classList.remove('hidden');
            appScreen.classList.add('hidden');
        }
        
        function showApp() {
            authScreen.classList.add('hidden');
            appScreen.classList.remove('hidden');
        }
        
        function setLoading(loading) {
            if (loading) {
                authAction.innerHTML = '<div class="spinner"></div> Processing...';
                authAction.disabled = true;
            } else {
                authAction.innerHTML = isLoginMode ? 
                    '<i class="fas fa-sign-in-alt"></i> Login' : 
                    '<i class="fas fa-user-plus"></i> Register';
                authAction.disabled = false;
            }
        }
        
        function showError(message) {
            authError.textContent = message;
            authError.classList.remove('hidden');
        }
        
        function showToast(message) {
            // Remove existing toasts
            const existingToasts = document.querySelectorAll('.toast');
            existingToasts.forEach(toast => toast.remove());
            
            // Create new toast
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.innerHTML = `
                <i class="fas fa-check-circle" style="color: var(--accent);"></i>
                <span>${message}</span>
            `;
            
            document.body.appendChild(toast);
            
            // Remove toast after animation
            setTimeout(() => {
                if (toast.parentNode) {
                    toast.parentNode.removeChild(toast);
                }
            }, 3000);
        }
        
        function clearForm() {
            inAmtEl.value = '';
            outAmtEl.value = '';
            noteEl.value = '';
            categoryEl.value = '';
            entryDateEl.valueAsDate = new Date();
        }
        
        function loadUserData() {
            if (!currentUser) return;
            
            db.collection('entries')
                .where('userId', '==', currentUser.uid)
                .orderBy('timestamp', 'desc')
                .onSnapshot(snapshot => {
                    entries = [];
                    snapshot.forEach(doc => {
                        const data = doc.data();
                        entries.push({ 
                            id: doc.id, 
                            ...data,
                            // Ensure timestamp is a Date object
                            timestamp: data.timestamp ? data.timestamp.toDate() : new Date()
                        });
                    });
                    updateDashboard();
                    renderEntries();
                    updateStats();
                    updateExpenseCategories();
                    updateSavingsGoalProgress();
                }, error => {
                    console.error("Error loading data:", error);
                    showToast("Error loading data. Using local storage as fallback.");
                    loadFromLocalStorage();
                });
        }
        
        function loadFromLocalStorage() {
            const localData = localStorage.getItem(`vyapaar_entries_${currentUser.uid}`);
            if (localData) {
                entries = JSON.parse(localData);
                updateDashboard();
                renderEntries();
                updateStats();
                updateExpenseCategories();
                updateSavingsGoalProgress();
            }
        }
        
        function saveToLocalStorage() {
            if (currentUser) {
                localStorage.setItem(`vyapaar_entries_${currentUser.uid}`, JSON.stringify(entries));
            }
        }
        
        function addEntry(inAmt, outAmt, note, category, date) {
            if (!currentUser) return;
            
            const entryData = {
                userId: currentUser.uid,
                inAmt: inAmt,
                outAmt: outAmt,
                note: note,
                category: category,
                date: date,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Add to Firestore
            db.collection('entries').add(entryData)
                .then(docRef => {
                    console.log("Entry added with ID: ", docRef.id);
                    // Add to local array with the returned ID
                    entries.unshift({
                        id: docRef.id,
                        ...entryData,
                        timestamp: new Date() // Use current date as fallback
                    });
                    updateDashboard();
                    renderEntries();
                    updateStats();
                    updateExpenseCategories();
                    updateSavingsGoalProgress();
                    saveToLocalStorage();
                })
                .catch(error => {
                    console.error("Error adding entry: ", error);
                    showToast("Error saving to cloud. Saving locally.");
                    
                    // Fallback: Save to local storage
                    const localEntry = {
                        id: 'local_' + Date.now(),
                        ...entryData,
                        timestamp: new Date()
                    };
                    entries.unshift(localEntry);
                    updateDashboard();
                    renderEntries();
                    updateStats();
                    updateExpenseCategories();
                    updateSavingsGoalProgress();
                    saveToLocalStorage();
                });
        }
        
        function loadNudges() {
            if (!currentUser) return;
            
            // Try to load from Firestore first
            db.collection('nudges')
                .where('userId', '==', currentUser.uid)
                .get()
                .then(snapshot => {
                    if (snapshot.empty) {
                        // No nudges found, create default ones
                        createDefaultNudges();
                    } else {
                        nudges = [];
                        snapshot.forEach(doc => {
                            nudges.push({ id: doc.id, ...doc.data() });
                        });
                        renderNudges();
                    }
                })
                .catch(error => {
                    console.error("Error loading nudges: ", error);
                    // Fallback to local storage
                    const localNudges = localStorage.getItem(`vyapaar_nudges_${currentUser.uid}`);
                    if (localNudges) {
                        nudges = JSON.parse(localNudges);
                    } else {
                        // Create default nudges
                        nudges = [...defaultNudges];
                        saveNudgesToLocalStorage();
                    }
                    renderNudges();
                });
        }
        
        function createDefaultNudges() {
            if (!currentUser) return;
            
            const batch = db.batch();
            nudges = [];
            
            defaultNudges.forEach((nudge, index) => {
                const nudgeRef = db.collection('nudges').doc();
                const nudgeData = {
                    userId: currentUser.uid,
                    text: nudge.text,
                    meta: nudge.meta,
                    completed: false,
                    order: index
                };
                batch.set(nudgeRef, nudgeData);
                nudges.push({ id: nudgeRef.id, ...nudgeData });
            });
            
            batch.commit()
                .then(() => {
                    renderNudges();
                })
                .catch(error => {
                    console.error("Error creating default nudges: ", error);
                    // Save to local storage as fallback
                    nudges = [...defaultNudges];
                    saveNudgesToLocalStorage();
                    renderNudges();
                });
        }
        
        function createNudge(text, meta = '') {
            if (!currentUser) return;
            
            const nudgeData = {
                userId: currentUser.uid,
                text: text,
                meta: meta,
                completed: false,
                timestamp: firebase.firestore.FieldValue.serverTimestamp()
            };
            
            // Add to Firestore
            db.collection('nudges').add(nudgeData)
                .then(docRef => {
                    nudges.push({ id: docRef.id, ...nudgeData });
                    renderNudges();
                    showToast('Nudge created successfully!');
                })
                .catch(error => {
                    console.error("Error creating nudge: ", error);
                    // Fallback to local storage
                    const localNudge = {
                        id: 'local_nudge_' + Date.now(),
                        ...nudgeData,
                        timestamp: new Date()
                    };
                    nudges.push(localNudge);
                    saveNudgesToLocalStorage();
                    renderNudges();
                    showToast('Nudge created successfully!');
                });
        }
        
        function deleteNudge(nudgeId) {
            if (!currentUser) return;
            
            // Remove from Firestore if it's not a local nudge
            if (!nudgeId.startsWith('local_')) {
                db.collection('nudges').doc(nudgeId).delete()
                    .catch(error => {
                        console.error("Error deleting nudge: ", error);
                    });
            }
            
            // Remove from local array
            nudges = nudges.filter(nudge => nudge.id !== nudgeId);
            renderNudges();
            saveNudgesToLocalStorage();
            showToast('Nudge deleted successfully!');
        }
        
        function clearCompletedNudges() {
            if (!currentUser) return;
            
            const completedNudges = nudges.filter(nudge => nudge.completed);
            
            // Remove from Firestore
            completedNudges.forEach(nudge => {
                if (!nudge.id.startsWith('local_')) {
                    db.collection('nudges').doc(nudge.id).delete()
                        .catch(error => {
                            console.error("Error deleting nudge: ", error);
                        });
                }
            });
            
            // Remove from local array
            nudges = nudges.filter(nudge => !nudge.completed);
            renderNudges();
            saveNudgesToLocalStorage();
            showToast('Completed nudges cleared!');
        }
        
        function toggleNudgeCompletion(nudgeId) {
            const nudgeIndex = nudges.findIndex(n => n.id === nudgeId);
            if (nudgeIndex === -1) return;
            
            nudges[nudgeIndex].completed = !nudges[nudgeIndex].completed;
            
            // Update in Firestore if possible
            if (nudgeId.startsWith('local_')) {
                saveNudgesToLocalStorage();
            } else {
                db.collection('nudges').doc(nudgeId).update({
                    completed: nudges[nudgeIndex].completed
                }).catch(error => {
                    console.error("Error updating nudge: ", error);
                    saveNudgesToLocalStorage();
                });
            }
            
            renderNudges();
            showToast(nudges[nudgeIndex].completed ? 'Nudge completed!' : 'Nudge marked as incomplete');
        }
        
        function saveNudgesToLocalStorage() {
            if (currentUser) {
                localStorage.setItem(`vyapaar_nudges_${currentUser.uid}`, JSON.stringify(nudges));
            }
        }
        
        function renderNudges() {
            if (!nudgesList) return;
            
            nudgesList.innerHTML = '';
            
            if (nudges.length === 0) {
                nudgesList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--muted);">
                        <i class="fas fa-lightbulb" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <div>No nudges available. Create your first nudge!</div>
                    </div>
                `;
                return;
            }
            
            nudges.forEach(nudge => {
                const nudgeEl = document.createElement('li');
                nudgeEl.className = `nudge-item ${nudge.completed ? 'nudge-completed' : ''}`;
                nudgeEl.innerHTML = `
                    <div class="nudge-details">
                        <div class="nudge-title">${nudge.text}</div>
                        ${nudge.meta ? `<div class="nudge-meta">${nudge.meta}</div>` : ''}
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button class="btn ${nudge.completed ? 'btn-alt' : 'btn-primary'}" data-nudge-id="${nudge.id}">
                            ${nudge.completed ? 'Undo' : 'Complete'}
                        </button>
                        <button class="btn btn-danger" data-delete-nudge="${nudge.id}">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                
                nudgesList.appendChild(nudgeEl);
                
                // Add event listener to the complete button
                const completeButton = nudgeEl.querySelector('[data-nudge-id]');
                completeButton.addEventListener('click', () => {
                    toggleNudgeCompletion(nudge.id);
                });
                
                // Add event listener to the delete button
                const deleteButton = nudgeEl.querySelector('[data-delete-nudge]');
                deleteButton.addEventListener('click', () => {
                    if (confirm('Are you sure you want to delete this nudge?')) {
                        deleteNudge(nudge.id);
                    }
                });
            });
        }
        
        function loadSavingsGoal() {
            if (!currentUser) return;
            
            const goalData = localStorage.getItem(`vyapaar_goal_${currentUser.uid}`);
            if (goalData) {
                savingsGoal = JSON.parse(goalData);
                updateSavingsGoalUI();
            }
        }
        
        function setSavingsGoal(name, amount) {
            if (!currentUser) return;
            
            savingsGoal = {
                name: name,
                targetAmount: amount,
                savedAmount: 0,
                createdAt: new Date()
            };
            
            localStorage.setItem(`vyapaar_goal_${currentUser.uid}`, JSON.stringify(savingsGoal));
            updateSavingsGoalUI();
            showToast('Savings goal set successfully!');
        }
        
        function updateSavingsGoalUI() {
            if (!savingsGoal) {
                goalProgressEl.style.display = 'none';
                return;
            }
            
            goalProgressEl.style.display = 'block';
            goalTitleEl.textContent = savingsGoal.name;
            goalTargetEl.textContent = savingsGoal.targetAmount.toLocaleString();
            goalSavedEl.textContent = savingsGoal.savedAmount.toLocaleString();
            
            const progressPercentage = Math.min((savingsGoal.savedAmount / savingsGoal.targetAmount) * 100, 100);
            goalProgressBarEl.style.width = `${progressPercentage}%`;
        }
        
        function updateSavingsGoalProgress() {
            if (!savingsGoal) return;
            
            // Calculate total savings (income minus expenses)
            const totalIncome = entries.reduce((sum, entry) => sum + (entry.inAmt || 0), 0);
            const totalExpenses = entries.reduce((sum, entry) => sum + (entry.outAmt || 0), 0);
            const netSavings = totalIncome - totalExpenses;
            
            // Update saved amount (can't exceed target)
            savingsGoal.savedAmount = Math.min(netSavings, savingsGoal.targetAmount);
            
            // Save updated goal
            if (currentUser) {
                localStorage.setItem(`vyapaar_goal_${currentUser.uid}`, JSON.stringify(savingsGoal));
            }
            
            updateSavingsGoalUI();
        }
        
        function updateDashboard() {
            // Calculate totals
            const totalIn = entries.reduce((sum, entry) => sum + (entry.inAmt || 0), 0);
            const totalOut = entries.reduce((sum, entry) => sum + (entry.outAmt || 0), 0);
            const net = totalIn - totalOut;
            
            // Update UI
            totalInEl.textContent = `₹${totalIn.toLocaleString()}`;
            totalOutEl.textContent = `₹${totalOut.toLocaleString()}`;
            totalNetEl.textContent = `₹${net.toLocaleString()}`;
            
            // Update recent transactions
            updateRecentTransactions();
            
            // Update chart
            updateCashflowChart();
        }
        
        function updateExpenseCategories() {
            const categories = ['supplies', 'services', 'transport', 'utilities'];
            
            categories.forEach(category => {
                const total = entries
                    .filter(entry => entry.category === category)
                    .reduce((sum, entry) => sum + (entry.outAmt || 0), 0);
                
                document.getElementById(`category-${category}`).textContent = `₹${total.toLocaleString()}`;
            });
        }
        
        function updateStats() {
            statTransactionsEl.textContent = entries.length;
            
            // Calculate this month's total
            const now = new Date();
            const thisMonth = now.getMonth();
            const thisYear = now.getFullYear();
            
            const monthTotal = entries
                .filter(entry => {
                    const entryDate = entry.timestamp;
                    return entryDate.getMonth() === thisMonth && entryDate.getFullYear() === thisYear;
                })
                .reduce((sum, entry) => sum + (entry.inAmt || 0) - (entry.outAmt || 0), 0);
            
            statMonthEl.textContent = `₹${monthTotal.toLocaleString()}`;
            
            // Count unique categories
            const categories = new Set(entries.map(entry => entry.category).filter(Boolean));
            statCategoriesEl.textContent = categories.size;
        }
        
        function updateRecentTransactions() {
            if (!recentTransactionsEl) return;
            
            recentTransactionsEl.innerHTML = '';
            
            const recent = entries.slice(0, 5);
            
            if (recent.length === 0) {
                recentTransactionsEl.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--muted);">
                        No transactions yet. Add your first transaction in the Ledger.
                    </div>
                `;
                return;
            }
            
            recent.forEach(entry => {
                const amount = (entry.inAmt || 0) - (entry.outAmt || 0);
                const date = entry.timestamp ? entry.timestamp.toLocaleDateString() : 'Unknown date';
                
                const entryEl = document.createElement('div');
                entryEl.className = 'entry-item';
                entryEl.innerHTML = `
                    <div class="entry-details">
                        <div class="entry-note">${entry.note}</div>
                        <div class="entry-meta">
                            <span>${date}</span>
                            <span>${entry.category ? `<span class="category-tag category-${amount >= 0 ? 'income' : 'expense'}">${entry.category}</span>` : ''}</span>
                        </div>
                    </div>
                    <div class="entry-amount" style="color: ${amount >= 0 ? 'var(--accent)' : 'var(--danger)'}">
                        ${amount >= 0 ? '+' : ''}₹${Math.abs(amount).toLocaleString()}
                    </div>
                `;
                
                recentTransactionsEl.appendChild(entryEl);
            });
        }
        
        function renderEntries() {
            if (!entriesList) return;
            
            entriesList.innerHTML = '';
            
            if (entries.length === 0) {
                entriesList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--muted);">
                        <i class="fas fa-receipt" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <div>No transactions yet. Add your first transaction above.</div>
                    </div>
                `;
                return;
            }
            
            // Apply filters
            let filteredEntries = entries;
            const searchTerm = searchEntriesEl.value.toLowerCase();
            const categoryFilter = filterCategoryEl.value;
            const typeFilter = filterTypeEl.value;
            
            if (searchTerm) {
                filteredEntries = filteredEntries.filter(entry => 
                    entry.note.toLowerCase().includes(searchTerm) ||
                    (entry.category && entry.category.toLowerCase().includes(searchTerm))
                );
            }
            
            if (categoryFilter) {
                filteredEntries = filteredEntries.filter(entry => entry.category === categoryFilter);
            }
            
            if (typeFilter) {
                if (typeFilter === 'income') {
                    filteredEntries = filteredEntries.filter(entry => (entry.inAmt || 0) > 0);
                } else if (typeFilter === 'expense') {
                    filteredEntries = filteredEntries.filter(entry => (entry.outAmt || 0) > 0);
                }
            }
            
            // Display filtered entries
            filteredEntries.forEach(entry => {
                const amount = (entry.inAmt || 0) - (entry.outAmt || 0);
                const date = entry.timestamp ? entry.timestamp.toLocaleDateString() : 'Unknown date';
                
                const entryEl = document.createElement('div');
                entryEl.className = 'entry-item';
                entryEl.innerHTML = `
                    <div class="entry-details">
                        <div class="entry-note">${entry.note}</div>
                        <div class="entry-meta">
                            <span>${date}</span>
                            <span>${entry.category ? `<span class="category-tag category-${amount >= 0 ? 'income' : 'expense'}">${entry.category}</span>` : ''}</span>
                        </div>
                    </div>
                    <div class="entry-amount" style="color: ${amount >= 0 ? 'var(--accent)' : 'var(--danger)'}">
                        ${amount >= 0 ? '+' : ''}₹${Math.abs(amount).toLocaleString()}
                    </div>
                `;
                
                entriesList.appendChild(entryEl);
            });
            
            // Show message if no entries match filters
            if (filteredEntries.length === 0) {
                entriesList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--muted);">
                        <i class="fas fa-search" style="font-size: 40px; margin-bottom: 15px;"></i>
                        <div>No transactions match your filters.</div>
                    </div>
                `;
            }
        }
        
        function updateCashflowChart() {
            const ctx = document.getElementById('cashflow-chart');
            if (!ctx) return;
            
            // Group by date (last 7 days)
            const last7Days = [...Array(7)].map((_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - i);
                return d.toLocaleDateString();
            }).reverse();
            
            const dailyData = last7Days.map(date => {
                const dayEntries = entries.filter(entry => {
                    if (!entry.timestamp) return false;
                    return entry.timestamp.toLocaleDateString() === date;
                });
                
                return {
                    in: dayEntries.reduce((sum, entry) => sum + (entry.inAmt || 0), 0),
                    out: dayEntries.reduce((sum, entry) => sum + (entry.outAmt || 0), 0)
                };
            });
            
            if (cashflowChart) {
                cashflowChart.destroy();
            }
            
            cashflowChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: last7Days,
                    datasets: [
                        {
                            label: 'Cash In',
                            data: dailyData.map(d => d.in),
                            backgroundColor: 'rgba(16, 185, 129, 0.7)',
                            borderColor: '#10b981',
                            borderWidth: 1
                        },
                        {
                            label: 'Cash Out',
                            data: dailyData.map(d => d.out),
                            backgroundColor: 'rgba(248, 113, 113, 0.7)',
                            borderColor: '#ef4444',
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#9aa6b2'
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#9aa6b2'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e6eef5'
                            }
                        }
                    }
                }
            });
        }
        
        function updateScenarioChart() {
            const ctx = document.getElementById('scenario-chart');
            if (!ctx) return;
            
            const savePerDay = parseInt(saveRange.value);
            
            // Projection for next 30 days
            const days = 30;
            const labels = Array.from({length: days}, (_, i) => `Day ${i+1}`);
            const projectedSavings = Array.from({length: days}, (_, i) => savePerDay * (i+1));
            
            if (scenarioChart) {
                scenarioChart.destroy();
            }
            
            scenarioChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Projected Savings',
                        data: projectedSavings,
                        borderColor: '#60a5fa',
                        tension: 0.1,
                        fill: true,
                        backgroundColor: 'rgba(96, 165, 250, 0.1)'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#9aa6b2',
                                callback: function(value) {
                                    return '₹' + value;
                                }
                            }
                        },
                        x: {
                            grid: {
                                color: 'rgba(255, 255, 255, 0.05)'
                            },
                            ticks: {
                                color: '#9aa6b2'
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            labels: {
                                color: '#e6eef5'
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return 'Savings: ₹' + context.raw;
                                }
                            }
                        }
                    }
                }
            });
        }
        
        function exportToCSV() {
            if (entries.length === 0) {
                showToast('No data to export');
                return;
            }
            
            let csv = 'Date,Note,Category,Cash In,Cash Out,Net\n';
            
            entries.forEach(entry => {
                const date = entry.timestamp ? entry.timestamp.toLocaleDateString() : 'Unknown date';
                const note = entry.note.replace(/"/g, '""');
                const category = entry.category || '';
                const inAmt = entry.inAmt || 0;
                const outAmt = entry.outAmt || 0;
                const net = inAmt - outAmt;
                
                csv += `"${date}","${note}","${category}",${inAmt},${outAmt},${net}\n`;
            });
            
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `vyapaar-saathi-export-${new Date().toISOString().slice(0,10)}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast('CSV exported successfully!');
        }
        
        function exportToPDF() {
            if (entries.length === 0) {
                showToast('No data to export');
                return;
            }
            
            // Get the jsPDF instance
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add title
            doc.setFontSize(20);
            doc.setTextColor(16, 185, 129);
            doc.text('Vyapaar-Saathi Financial Report', 105, 20, { align: 'center' });
            
            // Add date
            doc.setFontSize(12);
            doc.setTextColor(100, 100, 100);
            doc.text(`Generated on: ${new Date().toLocaleDateString()}`, 105, 30, { align: 'center' });
            
            // Add summary
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('Financial Summary', 20, 45);
            
            // Calculate totals
            const totalIn = entries.reduce((sum, entry) => sum + (entry.inAmt || 0), 0);
            const totalOut = entries.reduce((sum, entry) => sum + (entry.outAmt || 0), 0);
            const net = totalIn - totalOut;
            
            // Add summary data
            doc.setFontSize(12);
            doc.text(`Total Income: ₹${totalIn.toLocaleString()}`, 20, 55);
            doc.text(`Total Expenses: ₹${totalOut.toLocaleString()}`, 20, 65);
            doc.text(`Net: ₹${net.toLocaleString()}`, 20, 75);
            
            // Add transactions table
            doc.setFontSize(14);
            doc.setTextColor(0, 0, 0);
            doc.text('Transaction Details', 20, 90);
            
            // Table headers
            doc.setFillColor(16, 185, 129);
            doc.setTextColor(255, 255, 255);
            doc.rect(20, 95, 170, 10, 'F');
            doc.text('Date', 25, 101);
            doc.text('Description', 60, 101);
            doc.text('Amount', 150, 101);
            
            // Table rows
            doc.setTextColor(0, 0, 0);
            let y = 105;
            entries.slice(0, 20).forEach(entry => {
                if (y > 270) {
                    doc.addPage();
                    y = 20;
                }
                
                const date = entry.timestamp ? entry.timestamp.toLocaleDateString() : 'Unknown date';
                const note = entry.note.length > 30 ? entry.note.substring(0, 30) + '...' : entry.note;
                const amount = (entry.inAmt || 0) - (entry.outAmt || 0);
                
                doc.setFontSize(10);
                doc.text(date, 25, y);
                doc.text(note, 60, y);
                doc.text(`₹${amount.toLocaleString()}`, 150, y);
                
                y += 7;
            });
            
            // Save the PDF
            doc.save(`vyapaar-saathi-report-${new Date().toISOString().slice(0,10)}.pdf`);
            showToast('PDF exported successfully!');
        }
        
        // Initialize scenario chart and values
        if (saveRange) {
            saveRange.dispatchEvent(new Event('input'));
        }
    </script>
</body>
</html>